From 6abcdf44e338898e492f1d0a583534a32d7e3701 Mon Sep 17 00:00:00 2001
From: Rocka <i@rocka.me>
Date: Sun, 25 Jan 2026 01:36:10 +0800
Subject: [PATCH] android: disable ifaddrs stuff and fix build for sdk < 24

---
 include/uv/unix.h |  5 +++++
 src/unix/linux.c  | 14 ++++++++++++++
 src/unix/tcp.c    |  4 ++--
 3 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/include/uv/unix.h b/include/uv/unix.h
index 7c972026f..0ed1b512c 100644
--- a/include/uv/unix.h
+++ b/include/uv/unix.h
@@ -137,6 +137,11 @@ typedef UV_PLATFORM_SEM_T uv_sem_t;
 typedef pthread_cond_t uv_cond_t;
 typedef pthread_key_t uv_key_t;
 
+// we do not have pthread_barrier_init until Android API level 24
+#if defined(__ANDROID__) && __ANDROID_API__ < __ANDROID_API_N__
+# undef PTHREAD_BARRIER_SERIAL_THREAD
+#endif
+
 /* Note: guard clauses should match uv_barrier_init's in src/unix/thread.c. */
 #if defined(_AIX) || \
     defined(__OpenBSD__) || \
diff --git a/src/unix/linux.c b/src/unix/linux.c
index ea3e2de03..298cf88b0 100644
--- a/src/unix/linux.c
+++ b/src/unix/linux.c
@@ -37,7 +37,10 @@
 #include <errno.h>
 
 #include <fcntl.h>
+#define HAS_IFADDRS (!defined(__ANDROID__) && __ANDROID_API__ < __ANDROID_API_N__)
+#if HAS_IFADDRS
 #include <ifaddrs.h>
+#endif
 #include <net/ethernet.h>
 #include <net/if.h>
 #include <netpacket/packet.h>
@@ -56,6 +59,11 @@
 #include <time.h>
 #include <unistd.h>
 
+// ndk r28 does not have this definition: https://github.com/android/ndk/issues/2136
+#if defined(__ANDROID__) && !defined(LLONG_MAX)
+# define LLONG_MAX 0x7fffffffffffffffLL
+#endif
+
 #ifndef __NR_io_uring_setup
 # define __NR_io_uring_setup 425
 #endif
@@ -1941,6 +1949,8 @@ nocpuinfo:
 
 
 static int uv__ifaddr_exclude(struct ifaddrs *ent, int exclude_type) {
+// disable ifaddrs stuff on Android
+#if HAS_IFADDRS
   if (!((ent->ifa_flags & IFF_UP) && (ent->ifa_flags & IFF_RUNNING)))
     return 1;
   if (ent->ifa_addr == NULL)
@@ -1952,10 +1962,13 @@ static int uv__ifaddr_exclude(struct ifaddrs *ent, int exclude_type) {
   if (ent->ifa_addr->sa_family == PF_PACKET)
     return exclude_type;
   return !exclude_type;
+#endif
 }
 
 /* TODO(bnoordhuis) share with bsd-ifaddrs.c */
 int uv_interface_addresses(uv_interface_address_t** addresses, int* count) {
+// disable ifaddrs stuff on Android
+#if HAS_IFADDRS
   uv_interface_address_t* address;
   struct sockaddr_ll* sll;
   struct ifaddrs* addrs;
@@ -2042,6 +2055,7 @@ int uv_interface_addresses(uv_interface_address_t** addresses, int* count) {
   freeifaddrs(addrs);
 
   return 0;
+#endif
 }
 
 
diff --git a/src/unix/tcp.c b/src/unix/tcp.c
index 98970d752..c39cdb030 100644
--- a/src/unix/tcp.c
+++ b/src/unix/tcp.c
@@ -31,7 +31,7 @@
 #include <sys/socket.h>
 
 /* ifaddrs is not implemented on AIX and IBM i PASE */
-#if !defined(_AIX)
+#if !defined(_AIX) || !defined(__ANDROID__)
 #include <ifaddrs.h>
 #endif
 
@@ -228,7 +228,7 @@ static int uv__is_ipv6_link_local(const struct sockaddr* addr) {
 static int uv__ipv6_link_local_scope_id(void) {
   struct sockaddr_in6* a6;
   int rv;
-#if defined(_AIX)
+#if defined(_AIX) || defined(__ANDROID__)
   /* AIX & IBM i do not have ifaddrs
    * so fallback to use uv_interface_addresses */
   uv_interface_address_t* interfaces;
-- 
2.52.0

