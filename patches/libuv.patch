From 343d4ab523816ecdb126ddcb0d8b9d6f23edac0c Mon Sep 17 00:00:00 2001
From: Rocka <i@rocka.me>
Date: Sun, 25 Jan 2026 00:44:13 +0800
Subject: [PATCH] android: fix build for sdk level < 24 and disable tcp

---
 CMakeLists.txt    |  4 ++++
 include/uv/unix.h |  5 +++++
 src/unix/linux.c  | 10 ++++++++++
 3 files changed, 19 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 73d5aff89..e2137da54 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -252,6 +252,10 @@ else()
        src/unix/thread.c
        src/unix/tty.c
        src/unix/udp.c)
+  if(CMAKE_SYSTEM_NAME MATCHES "Android")
+    # disable tcp on Android
+    list(REMOVE_ITEM uv_sources src/unix/tcp.c)
+  endif()
   list(APPEND uv_test_sources test/runner-unix.c)
 endif()
 
diff --git a/include/uv/unix.h b/include/uv/unix.h
index 7c972026f..0ed1b512c 100644
--- a/include/uv/unix.h
+++ b/include/uv/unix.h
@@ -137,6 +137,11 @@ typedef UV_PLATFORM_SEM_T uv_sem_t;
 typedef pthread_cond_t uv_cond_t;
 typedef pthread_key_t uv_key_t;
 
+// we do not have pthread_barrier_init until Android API level 24
+#if defined(__ANDROID__) && __ANDROID_API__ < __ANDROID_API_N__
+# undef PTHREAD_BARRIER_SERIAL_THREAD
+#endif
+
 /* Note: guard clauses should match uv_barrier_init's in src/unix/thread.c. */
 #if defined(_AIX) || \
     defined(__OpenBSD__) || \
diff --git a/src/unix/linux.c b/src/unix/linux.c
index ea3e2de03..71a02fe21 100644
--- a/src/unix/linux.c
+++ b/src/unix/linux.c
@@ -37,7 +37,9 @@
 #include <errno.h>
 
 #include <fcntl.h>
+#if !defined(__ANDROID__)
 #include <ifaddrs.h>
+#endif
 #include <net/ethernet.h>
 #include <net/if.h>
 #include <netpacket/packet.h>
@@ -56,6 +58,11 @@
 #include <time.h>
 #include <unistd.h>
 
+// ndk r28 does not have this definition: https://github.com/android/ndk/issues/2136
+#if defined(__ANDROID__) && !defined(LLONG_MAX)
+# define LLONG_MAX 0x7fffffffffffffffLL
+#endif
+
 #ifndef __NR_io_uring_setup
 # define __NR_io_uring_setup 425
 #endif
@@ -1940,6 +1947,8 @@ nocpuinfo:
 }
 
 
+// disable tcp on Android
+#if !defined(__ANDROID__)
 static int uv__ifaddr_exclude(struct ifaddrs *ent, int exclude_type) {
   if (!((ent->ifa_flags & IFF_UP) && (ent->ifa_flags & IFF_RUNNING)))
     return 1;
@@ -2050,6 +2059,7 @@ void uv_free_interface_addresses(uv_interface_address_t* addresses,
                                  int count) {
   uv__free(addresses);
 }
+#endif
 
 
 void uv__set_process_title(const char* title) {
-- 
2.52.0

